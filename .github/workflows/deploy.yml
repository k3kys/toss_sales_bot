name: Deploy to GCP

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: SSH Remote Commands
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # 1. 프로젝트 폴더로 이동 (폴더가 없으면 에러가 날 수 있으니 미리 한 번 만들어둠)
          mkdir -p ~/toss_sales_bot
          cd ~/toss_sales_bot

          # 2. 깃허브에서 최신 코드 가져오기 (만약 처음이라면 clone을, 아니면 fetch를 수행)
          if [ ! -d ".git" ]; then
            git clone https://github.com/${{ github.repository }} .
          fi
          git fetch origin main
          git reset --hard origin/main

          # 3. .env 파일 생성 (깃허브 금고에서 꺼내서 서버에 파일로 굽기)
          echo "TOSS_SECRET_KEY=${{ secrets.TOSS_SECRET_KEY }}" > .env
          echo "SOLAPI_API_KEY=${{ secrets.SOLAPI_API_KEY }}" >> .env
          echo "SOLAPI_API_SECRET=${{ secrets.SOLAPI_API_SECRET }}" >> .env
          echo "SENDER_PHONE=${{ secrets.SENDER_PHONE }}" >> .env
          echo "MANAGER_PHONE=${{ secrets.MANAGER_PHONE }}" >> .env

          # 4. Docker 컨테이너 재시작 (기존 것 끄고 -> 새로 빌드해서 켜기)
          # (sudo가 필요할 수 있어 앞에 붙임)
          docker compose down
          docker compose up -d --build
          
          # 5. 청소 (쓰지 않는 구버전 이미지 삭제)
          docker image prune -f