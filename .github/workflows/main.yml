name: Toss Sales Bot CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # [1단계] 빌드 검증
  build-test:
    name: Build Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create dummy .env file
        run: |
          echo "TOSS_API_KEY=dummy" >> .env
          echo "DATABASE_URL=sqlite:///./dummy.db" >> .env
          echo "SOLAPI_API_KEY=dummy" >> .env
          echo "SOLAPI_API_SECRET=dummy" >> .env
          echo "SENDER_PHONE=01000000000" >> .env
          echo "MANAGER_PHONE=01000000000" >> .env
          echo "TZ=Asia/Seoul" >> .env

      - name: Test Docker Build
        run: docker compose build

  # [2단계] 서버 배포
  deploy:
    name: Deploy to GCP
    needs: build-test
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            mkdir -p ~/toss_sales_bot
            cd ~/toss_sales_bot

            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }} .
            fi
            git fetch origin main
            git reset --hard origin/main

            # [핵심 수정] 파이썬 코드가 원하는 이름으로 매핑하여 저장
            echo "TOSS_API_KEY=${{ secrets.TOSS_SECRET_KEY }}" > .env
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
            
            # 나머지 변수들
            echo "SOLAPI_API_KEY=${{ secrets.SOLAPI_API_KEY }}" >> .env
            echo "SOLAPI_API_SECRET=${{ secrets.SOLAPI_API_SECRET }}" >> .env
            echo "SENDER_PHONE=${{ secrets.SENDER_PHONE }}" >> .env
            echo "MANAGER_PHONE=${{ secrets.MANAGER_PHONE }}" >> .env

            docker compose down
            docker compose up -d --build
            docker image prune -f