<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë² ì§€ë‚˜ì´ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-badge { font-size: 0.8em; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-success mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="bi bi-robot"></i> ë² ì§€ë‚˜ì´ v1.0</a>
            <span class="text-white">ê´€ë¦¬ì ëª¨ë“œ</span>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card p-3">
                    <h4>ğŸ¥¦ ë§¤ì¥ ê´€ë¦¬ í˜„í™©</h4>
                    <p class="text-muted mb-0">ì´ ë“±ë¡ ë§¤ì¥: <strong id="userCount">{{ users|length }}</strong>ê³³</p>
                </div>
            </div>
            <div class="col-md-4 text-end d-flex align-items-center justify-content-end gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal" onclick="resetForm()">
                    <i class="bi bi-plus-lg"></i> ë§¤ì¥ ë“±ë¡
                </button>
                <button class="btn btn-warning text-white" onclick="sendManualReport()">
                    <i class="bi bi-send-fill"></i> ë¦¬í¬íŠ¸ ê°•ì œ ë°œì†¡
                </button>
            </div>
        </div>

        <div class="card p-4 shadow-sm bg-white rounded">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>ë§¤ì¥ëª…</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>í”Œëœ</th>
                        <th>ë§Œë£Œì¼</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td class="fw-bold">{{ user.username }}</td>
                        <td>{{ user.phone_number }}</td>
                        <td>
                            <span class="badge bg-info text-dark">{{ user.plan_type }}</span>
                        </td>
                        <td>{{ user.expiration_date.strftime('%Y-%m-%d') if user.expiration_date else '-' }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" 
                                onclick="editUser('{{ user.id }}', '{{ user.username }}', '{{ user.phone_number }}', '{{ user.plan_type }}')">
                                ìˆ˜ì •
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('{{ user.id }}')">
                                ì‚­ì œ
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">ë§¤ì¥ ë“±ë¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label class="form-label">ë§¤ì¥ëª… (Username)</label>
                        <input type="text" class="form-control" id="inputUsername">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                        <input type="text" class="form-control" id="inputPhone" placeholder="01012345678">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">í† ìŠ¤ í† í°</label>
                        <input type="text" class="form-control" id="inputToken" value="dummy_token">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">êµ¬ë… í”Œëœ</label>
                        <select class="form-select" id="inputPlan">
                            <option value="TRIAL">ì²´í—˜íŒ (7ì¼)</option>
                            <option value="3M">3ê°œì›”</option>
                            <option value="6M">6ê°œì›”</option>
                            <option value="1Y">1ë…„</option>
                            <option value="2Y">2ë…„</option>
                            <option value="UNLIMITED">ë¬´ì œí•œ</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-success" onclick="saveUser()">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // í¼ ì´ˆê¸°í™”
        function resetForm() {
            document.getElementById('editUserId').value = '';
            document.getElementById('inputUsername').value = '';
            document.getElementById('inputPhone').value = '';
            document.getElementById('inputUsername').disabled = false; // ë“±ë¡í•  ë• ì´ë¦„ ìˆ˜ì • ê°€ëŠ¥
            document.getElementById('modalTitle').innerText = "ì‹ ê·œ ë§¤ì¥ ë“±ë¡";
        }

        // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ
        function editUser(id, name, phone, plan) {
            document.getElementById('editUserId').value = id;
            document.getElementById('inputUsername').value = name;
            document.getElementById('inputUsername').disabled = true; // ìˆ˜ì •í•  ë• ì´ë¦„ ë³€ê²½ ë¶ˆê°€ (ì‹ë³„ìë¼)
            document.getElementById('inputPhone').value = phone;
            document.getElementById('inputPlan').value = plan;
            
            document.getElementById('modalTitle').innerText = "ë§¤ì¥ ì •ë³´ ìˆ˜ì •";
            
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        // ì €ì¥ (ë“±ë¡/ìˆ˜ì • ë¶„ê¸°)
        async function saveUser() {
            const id = document.getElementById('editUserId').value;
            const username = document.getElementById('inputUsername').value;
            const phone = document.getElementById('inputPhone').value;
            const token = document.getElementById('inputToken').value;
            const plan = document.getElementById('inputPlan').value;

            let url = "/users/";
            let method = "POST";
            let body = {
                username: username,
                phone_number: phone,
                toss_token: token,
                plan_type: plan
            };

            // IDê°€ ìˆìœ¼ë©´ ìˆ˜ì • ëª¨ë“œ (PUT)
            if (id) {
                url = `/users/${id}`;
                method = "PUT";
                // ìˆ˜ì • ì‹œ usernameì€ ë³´ë‚´ì§€ ì•ŠìŒ (ìŠ¤í‚¤ë§ˆ ì°¸ì¡°)
                delete body.username; 
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    location.reload(); // ìƒˆë¡œê³ ì¹¨
                } else {
                    const err = await response.json();
                    alert("ì˜¤ë¥˜: " + err.detail);
                }
            } catch (e) {
                alert("í†µì‹  ì˜¤ë¥˜ ë°œìƒ");
            }
        }

        // ì‚­ì œ
        async function deleteUser(id) {
            if (!confirm("ì •ë§ ì´ ë§¤ì¥ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                const response = await fetch(`/users/${id}`, { method: "DELETE" });
                if (response.ok) {
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                } else {
                    alert("ì‚­ì œ ì‹¤íŒ¨");
                }
            } catch (e) {
                alert("ì˜¤ë¥˜ ë°œìƒ");
            }
        }

        // ìˆ˜ë™ ë¦¬í¬íŠ¸ ë°œì†¡
        async function sendManualReport() {
            if (!confirm("ì „ì²´ ë§¤ì¥ì— ì¼ì¼ ë¦¬í¬íŠ¸ë¥¼ ì§€ê¸ˆ ì¦‰ì‹œ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            try {
                const response = await fetch('/system/report', { method: "POST" });
                if (response.ok) {
                    alert("ë°œì†¡ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í•¸ë“œí°ì„ í™•ì¸í•˜ì„¸ìš”.");
                } else {
                    alert("ë°œì†¡ ì‹¤íŒ¨");
                }
            } catch (e) {
                alert("í†µì‹  ì˜¤ë¥˜");
            }
        }
    </script>
</body>
</html>